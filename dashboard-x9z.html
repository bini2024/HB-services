<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habesha Services - Admin Portal</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f7f6; --text: #333; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--bg); color: var(--text); }
        
        /* LOGIN STYLES */
        #login-screen { display: flex; height: 100vh; justify-content: center; align-items: center; background: var(--primary); }
        .login-box { background: white; padding: 2rem; border-radius: 8px; width: 300px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .login-box input { width: 90%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; }
        .login-box button { width: 100%; padding: 10px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; }
        
        /* DASHBOARD STYLES */
        #dashboard { display: none; }
        header { background: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        h1 { margin: 0; font-size: 1.5rem; color: var(--primary); }
        .logout-btn { background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }

        .container { padding: 2rem; max-width: 1200px; margin: 0 auto; }
        
        /* METRICS */
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .metric-card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; }
        .metric-num { font-size: 2rem; font-weight: bold; color: var(--accent); display: block; }
        .metric-label { color: #777; font-size: 0.9rem; }

        /* TABLE */
        .table-container { background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #fafafa; font-weight: 600; color: #555; }
        tr:hover { background: #f9f9f9; cursor: pointer; }

        /* ... existing styles ... */

/* NEW: Styles for Repeater Data (Mini Tables) */
.mini-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 5px;
    font-size: 0.9rem;
    background: #fff;
    border: 1px solid #ddd;
}
.mini-table th, .mini-table td {
    padding: 6px 10px;
    border: 1px solid #eee;
    text-align: left;
}
.mini-table th {
    background-color: #f1f3f5;
    font-weight: 600;
    font-size: 0.8rem;
    color: #555;
}
.detail-block {
    margin-bottom: 15px;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
}
.detail-label {
    display: block;
    font-size: 0.85rem;
    text-transform: uppercase;
    color: #888;
    margin-bottom: 4px;
    font-weight: 700;
}
.detail-value {
    font-size: 1rem;
    color: #333;
    font-weight: 500;
}

        /* BADGES */
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; }
        .badge.new { background: #e3f2fd; color: #1565c0; }
        .badge.progress { background: #fff3e0; color: #ef6c00; }
        .badge.completed { background: #e8f5e9; color: #2e7d32; }

        /* MODAL */
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background: white; width: 600px; max-height: 90vh; overflow-y: auto; padding: 2rem; border-radius: 8px; position: relative; }
        .close-btn { position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; cursor: pointer; }
        .detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        .detail-label { font-weight: bold; color: #555; }
        .file-link { display: inline-block; margin-top: 5px; color: var(--accent); text-decoration: none; border: 1px solid var(--accent); padding: 5px 10px; border-radius: 4px; }
        
        .status-select { padding: 8px; border-radius: 4px; margin-top: 20px; width: 100%; border: 1px solid #ccc; font-size: 1rem; }
        .save-btn { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 4px; margin-top: 10px; cursor: pointer; width: 100%; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>Admin Login</h2>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button onclick="login()">Login</button>
            <p id="login-error" style="color: red; margin-top: 10px; font-size: 0.9rem;"></p>
        </div>
    </div>

    <div id="dashboard">
        <header>
            <h1>Habesha Services Admin</h1>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </header>

        <div class="container">
            <div class="metrics">
                <div class="metric-card">
                    <span class="metric-num" id="count-total">0</span>
                    <span class="metric-label">Total Applications</span>
                </div>
                <div class="metric-card">
                    <span class="metric-num" id="count-new" style="color: #1565c0">0</span>
                    <span class="metric-label">New</span>
                </div>
                <div class="metric-card">
                    <span class="metric-num" id="count-pending" style="color: #ef6c00">0</span>
                    <span class="metric-label">In Progress</span>
                </div>
            </div>

            <div class="table-container">
                <table id="submissions-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Applicant Name</th>
                            <th>Service Type</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2 id="modal-title">Application Details</h2>
            <div id="modal-body"></div>
            
            <h3 style="margin-top: 20px;">Manage Application</h3>
            <label>Update Status:</label>
            <select id="modal-status" class="status-select">
                <option value="new">New</option>
                <option value="in_progress">In Progress</option>
                <option value="completed">Completed</option>
                <option value="rejected">Rejected</option>
            </select>
            <button class="save-btn" onclick="saveStatus()">Update Status</button>
        </div>
    </div>

   <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBzlRJwD_dJ9qh22zipP5Ux77q7-9IT33I",
        authDomain: "hb-services-87372.firebaseapp.com",
        projectId: "hb-services-87372",
        storageBucket: "hb-services-87372.firebasestorage.app",
        messagingSenderId: "326833059312",
        appId: "1:326833059312:web:cee34d9ec63c4adfd21935"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentSubmissions = [];
    let selectedId = null;

    // --- AUTH LOGIC ---
    window.login = async () => {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        try {
            await signInWithEmailAndPassword(auth, email, pass);
        } catch (error) {
            document.getElementById('login-error').innerText = "Invalid Credentials";
        }
    };

    window.logout = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            loadSubmissions();
        } else {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
        }
    });

    // --- DATA LOGIC ---
    async function loadSubmissions() {
        const q = query(collection(db, "submissions"), orderBy("submittedAt", "desc"));
        const querySnapshot = await getDocs(q);
        
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';
        
        let counts = { total: 0, new: 0, pending: 0 };
        currentSubmissions = [];

        querySnapshot.forEach((doc) => {
            const sub = doc.data();
            sub.id = doc.id;
            currentSubmissions.push(sub);

            counts.total++;
            if(sub.status === 'new') counts.new++;
            if(sub.status === 'in_progress') counts.pending++;

            let dateStr = "N/A";
            if(sub.submittedAt && typeof sub.submittedAt.toDate === 'function') {
                dateStr = sub.submittedAt.toDate().toLocaleDateString();
            }

            // Safe Name Access
            let name = 'Unknown';
            if (sub.data) {
                name = sub.data.full_name || sub.data.applicant_name || sub.data.groom_name || 
                       `${sub.data.given_names || ''} ${sub.data.surname || ''}`.trim();
            }
            if(!name) name = "Unknown Applicant";

            const tr = document.createElement('tr');
            tr.onclick = () => openModal(sub.id);
            // ESCAPE HTML FOR SECURITY
            tr.innerHTML = `
                <td>${escapeHtml(dateStr)}</td>
                <td><strong>${escapeHtml(name)}</strong></td>
                <td>${formatServiceId(sub.service)}</td>
                <td><span class="badge ${getStatusClass(sub.status)}">${formatStatus(sub.status)}</span></td>
                <td><button style="padding:5px;">View</button></td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById('count-total').innerText = counts.total;
        document.getElementById('count-new').innerText = counts.new;
        document.getElementById('count-pending').innerText = counts.pending;
    }

    // --- MODAL LOGIC ---
    window.openModal = (id) => {
        selectedId = id;
        const sub = currentSubmissions.find(s => s.id === id);
        const modalBody = document.getElementById('modal-body');
        document.getElementById('modal-status').value = sub.status || 'new';

        let contentHtml = '';

        // 1. Files
        if(sub.documents && sub.documents.length > 0) {
            contentHtml += `<h3>Attached Documents</h3><div style="margin-bottom:15px;">`;
            sub.documents.forEach(doc => {
                contentHtml += `<a href="${doc.url}" target="_blank" class="file-link">ðŸ“„ ${escapeHtml(doc.name)}</a> `;
            });
            contentHtml += `</div>`;
        } else {
            contentHtml += `<p><em>No documents uploaded.</em></p>`;
        }

        // 2. Form Data (Smart Render)
        contentHtml += `<h3>Form Data</h3>`;
        
        for (const [key, value] of Object.entries(sub.data)) {
            const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            
            contentHtml += `<div class="detail-block"><span class="detail-label">${label}</span>`;

            // CHECK: Is this a Repeater (Array of Objects)?
            if (Array.isArray(value) && value.length > 0 && typeof value[0] === 'object') {
                contentHtml += `<table class="mini-table"><thead><tr>`;
                
                // Get headers from first object
                const headers = Object.keys(value[0]);
                headers.forEach(h => {
                    contentHtml += `<th>${h.replace(/_/g, ' ')}</th>`;
                });
                contentHtml += `</tr></thead><tbody>`;
                
                // Rows
                value.forEach(row => {
                    contentHtml += `<tr>`;
                    headers.forEach(h => {
                        contentHtml += `<td>${escapeHtml(row[h] || '')}</td>`;
                    });
                    contentHtml += `</tr>`;
                });
                contentHtml += `</tbody></table>`;
            } 
            // CHECK: Is it a simple Array (Checkbox Group)?
            else if (Array.isArray(value)) {
                contentHtml += `<div class="detail-value">${escapeHtml(value.join(', '))}</div>`;
            }
            // CHECK: Boolean (Single Checkbox)
            else if (typeof value === 'boolean') {
                contentHtml += `<div class="detail-value">${value ? 'Yes' : 'No'}</div>`;
            }
            // STANDARD: String
            else {
                contentHtml += `<div class="detail-value">${escapeHtml(String(value))}</div>`;
            }
            
            contentHtml += `</div>`;
        }

        modalBody.innerHTML = contentHtml;
        document.getElementById('modal').style.display = 'flex';
    };

    window.closeModal = () => { document.getElementById('modal').style.display = 'none'; };

    window.saveStatus = async () => {
        if(!selectedId) return;
        const newStatus = document.getElementById('modal-status').value;
        const btn = document.querySelector('.save-btn');
        btn.innerText = "Saving...";
        
        try {
            const ref = doc(db, "submissions", selectedId);
            await updateDoc(ref, { status: newStatus });
            alert("Status Updated!");
            closeModal();
            loadSubmissions(); 
        } catch (e) {
            alert("Error updating: " + e.message);
        } finally {
            btn.innerText = "Update Status";
        }
    };

    // --- HELPERS ---
    
    // SECURITY: Prevent XSS
    function escapeHtml(text) {
        if (!text) return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return String(text).replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    function formatServiceId(id) {
        if(!id) return 'Unknown';
        return id.replace(/_/g, ' ').toUpperCase();
    }

    function getStatusClass(status) {
        if (status === 'new') return 'new';
        if (status === 'in_progress') return 'progress';
        if (status === 'completed') return 'completed';
        return '';
    }

    function formatStatus(status) {
        if(!status) return 'New';
        return status.replace(/_/g, ' ').toUpperCase();
    }
</script>
</body>
</html>
