<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HB Services - Admin Portal</title>
    <style>
        :root { --primary: #2c3e50; --accent: #28a745; --bg: #f4f7f6; --text: #333; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--bg); color: var(--text); }
        
        /* LOGIN STYLES */
        #login-screen { display: flex; height: 100vh; justify-content: center; align-items: center; background: var(--primary); }
        .login-box { background: white; padding: 2.5rem; border-radius: 12px; width: 320px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .login-box h2 { margin-top: 0; color: var(--primary); }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .login-box button { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1rem; transition: background 0.2s; }
        .login-box button:hover { background: #218838; }
        
        /* DASHBOARD STYLES */
        #dashboard { display: none; }
        header { background: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        h1 { margin: 0; font-size: 1.5rem; color: var(--primary); }
        .logout-btn { background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }

        .container { padding: 2rem; max-width: 1200px; margin: 0 auto; }
        
        /* METRICS */
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .metric-card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; }
        .metric-num { font-size: 2rem; font-weight: bold; color: var(--accent); display: block; }
        .metric-label { color: #777; font-size: 0.9rem; }

        /* TABLE */
        .table-container { background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #fafafa; font-weight: 600; color: #555; }
        tr:hover { background: #f9f9f9; cursor: pointer; }

        /* BADGES */
        .badge { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge.new { background: #e3f2fd; color: #1565c0; }
        .badge.in_progress { background: #fff3e0; color: #ef6c00; }
        .badge.completed { background: #e8f5e9; color: #2e7d32; }
        .badge.rejected { background: #ffebee; color: #c62828; }

        /* MODAL */
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; width: 700px; max-height: 90vh; overflow-y: auto; padding: 2rem; border-radius: 12px; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .close-btn { position: absolute; top: 1rem; right: 1.5rem; font-size: 2rem; cursor: pointer; color: #aaa; line-height: 1; }
        .close-btn:hover { color: #333; }
        
        .section-header { margin-top: 25px; border-bottom: 2px solid #eee; padding-bottom: 8px; color: var(--primary); font-size: 1.1rem; }
        
        .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .detail-item { margin-bottom: 10px; }
        .detail-label { display: block; font-size: 0.8rem; text-transform: uppercase; color: #888; font-weight: 700; margin-bottom: 4px; }
        .detail-value { font-size: 1rem; color: #333; word-break: break-word; }

        .file-link { display: inline-flex; align-items: center; gap: 8px; background: #f8f9fa; border: 1px solid #dee2e6; padding: 8px 12px; border-radius: 6px; text-decoration: none; color: #333; font-weight: 500; transition: all 0.2s; margin-right: 10px; margin-bottom: 10px; }
        .file-link:hover { background: #e2e6ea; border-color: #cbd3da; }

        /* Mini Table for Repeaters */
        .mini-table { width: 100%; border-collapse: collapse; margin-top: 10px; border: 1px solid #dee2e6; font-size: 0.9rem; }
        .mini-table th { background: #e9ecef; padding: 8px; border: 1px solid #dee2e6; }
        .mini-table td { padding: 8px; border: 1px solid #dee2e6; }

        .status-actions { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 30px; border: 1px solid #e9ecef; }
        .status-select { padding: 10px; border-radius: 6px; width: 100%; border: 1px solid #ced4da; font-size: 1rem; margin-bottom: 15px; }
        .save-btn { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; font-size: 1rem; font-weight: bold; transition: background 0.2s; }
        .save-btn:hover { background: #1a252f; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>Admin Portal</h2>
            <p style="color:#666; margin-bottom:20px;">Please sign in to manage applications.</p>
            <input type="email" id="email" placeholder="admin@hbservices.com">
            <input type="password" id="password" placeholder="Password">
            <button onclick="handleLogin()">Sign In</button>
            <p id="login-error" style="color: #dc3545; margin-top: 15px; font-size: 0.9rem; display: none;"></p>
        </div>
    </div>

    <div id="dashboard">
        <header>
            <h1>HB Services Admin</h1>
            <button class="logout-btn" onclick="handleLogout()">Logout</button>
        </header>

        <div class="container">
            <div class="metrics">
                <div class="metric-card">
                    <span class="metric-num" id="count-total">0</span>
                    <span class="metric-label">Total Applications</span>
                </div>
                <div class="metric-card">
                    <span class="metric-num" id="count-new" style="color: #1565c0">0</span>
                    <span class="metric-label">New / Pending</span>
                </div>
                <div class="metric-card">
                    <span class="metric-num" id="count-progress" style="color: #ef6c00">0</span>
                    <span class="metric-label">In Progress</span>
                </div>
            </div>

            <div class="table-container">
                <table id="submissions-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Applicant Name</th>
                            <th>Service Type</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        </tbody>
                </table>
                <p id="loading-msg" style="padding: 20px; text-align: center; color: #777;">Loading submissions...</p>
            </div>
        </div>
    </div>

    <div id="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2 id="modal-title" style="margin-top:0; color:var(--primary);">Application Details</h2>
            
            <div id="modal-body"></div>
            
            <div class="status-actions">
                <h3 style="margin-top:0;">Update Status</h3>
                <label style="display:block; margin-bottom:8px; font-weight:600; color:#555;">Current Status:</label>
                <select id="modal-status" class="status-select">
                    <option value="new">New</option>
                    <option value="in_progress">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="rejected">Rejected</option>
                </select>
                <button class="save-btn" onclick="saveStatus()">Save Changes</button>
            </div>
        </div>
    </div>

   <script type="module">
    import { 
        auth, db, 
        signInWithEmailAndPassword, signOut, onAuthStateChanged,
        collection, query, orderBy, getDocs, doc, updateDoc 
    } from './firebase-setup.js';
    import { services } from './config.js';

    let currentSubmissions = [];
    let selectedId = null;

    // --- AUTHENTICATION ---
    window.handleLogin = async () => {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        const errBox = document.getElementById('login-error');
        
        try {
            await signInWithEmailAndPassword(auth, email, pass);
            errBox.style.display = 'none';
        } catch (error) {
            console.error(error);
            errBox.innerText = "Invalid Email or Password.";
            errBox.style.display = 'block';
        }
    };

    window.handleLogout = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            loadSubmissions();
        } else {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
        }
    });

    // --- DATA LOADING ---
    async function loadSubmissions() {
        const tbody = document.getElementById('table-body');
        const loadMsg = document.getElementById('loading-msg');
        
        try {
            const q = query(collection(db, "submissions"), orderBy("submittedAt", "desc"));
            const querySnapshot = await getDocs(q);
            
            tbody.innerHTML = '';
            loadMsg.style.display = 'none';
            
            let counts = { total: 0, new: 0, progress: 0 };
            currentSubmissions = [];

            if(querySnapshot.empty) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No applications found.</td></tr>';
                return;
            }

            querySnapshot.forEach((doc) => {
                const sub = doc.data();
                sub.id = doc.id;
                currentSubmissions.push(sub);

                counts.total++;
                if(sub.status === 'new') counts.new++;
                if(sub.status === 'in_progress') counts.progress++;

                // Format Date
                let dateStr = "N/A";
                if(sub.submittedAt && sub.submittedAt.seconds) {
                    dateStr = new Date(sub.submittedAt.seconds * 1000).toLocaleDateString();
                }

                // Identify Name (Logic to find first available name field)
                let name = sub.data.full_name || sub.data.surname || sub.data.groom_name || sub.data.applicant_name || "Unknown";
                if(sub.data.given_names) name = `${sub.data.given_names} ${sub.data.surname}`;

                // Format Service Name
                const serviceObj = services.find(s => s.id === sub.service);
                const serviceLabel = serviceObj ? serviceObj.labels.en : sub.service;

                const tr = document.createElement('tr');
                tr.onclick = () => openModal(sub.id);
                tr.innerHTML = `
                    <td>${dateStr}</td>
                    <td><strong>${escapeHtml(name)}</strong></td>
                    <td>${serviceLabel}</td>
                    <td><span class="badge ${sub.status}">${formatStatus(sub.status)}</span></td>
                    <td><button style="padding:6px 12px; cursor:pointer;">View</button></td>
                `;
                tbody.appendChild(tr);
            });

            // Update Metrics
            document.getElementById('count-total').innerText = counts.total;
            document.getElementById('count-new').innerText = counts.new;
            document.getElementById('count-progress').innerText = counts.progress;

        } catch (error) {
            console.error("Error loading data:", error);
            if(error.code === 'permission-denied') {
                alert("Permission Denied: Check Firestore Rules!");
            }
        }
    }

    // --- MODAL & LOGIC ---
    window.openModal = (id) => {
        selectedId = id;
        const sub = currentSubmissions.find(s => s.id === id);
        const modalBody = document.getElementById('modal-body');
        document.getElementById('modal-status').value = sub.status || 'new';

        let html = '';

        // 1. Documents Section
        if(sub.documents && sub.documents.length > 0) {
            html += `<h3 class="section-header">Attached Documents</h3><div style="margin-bottom:20px;">`;
            sub.documents.forEach(doc => {
                html += `<a href="${doc.url}" target="_blank" class="file-link">ðŸ“„ ${escapeHtml(doc.name)}</a>`;
            });
            html += `</div>`;
        }

        // 2. Data Section
        html += `<h3 class="section-header">Application Data</h3><div class="detail-grid">`;
        
        // Loop through data fields
        for (const [key, value] of Object.entries(sub.data)) {
            // Skip empty fields for cleanliness
            if(value === "" || value === null) continue;

            const label = key.replace(/_/g, ' ').toUpperCase();

            // Case A: Repeater (Array of Objects)
            if (Array.isArray(value) && value.length > 0 && typeof value[0] === 'object') {
                html += `</div><div class="detail-item" style="grid-column: 1 / -1; margin-top:10px;">
                    <span class="detail-label">${label}</span>
                    <table class="mini-table"><thead><tr>`;
                
                const headers = Object.keys(value[0]);
                headers.forEach(h => html += `<th>${h.replace(/_/g, ' ')}</th>`);
                html += `</tr></thead><tbody>`;
                
                value.forEach(row => {
                    html += `<tr>`;
                    headers.forEach(h => html += `<td>${escapeHtml(row[h])}</td>`);
                    html += `</tr>`;
                });
                html += `</tbody></table></div><div class="detail-grid">`; // Restart grid
            } 
            // Case B: Simple List (Checkbox Group)
            else if (Array.isArray(value)) {
                html += `<div class="detail-item"><span class="detail-label">${label}</span><div class="detail-value">${escapeHtml(value.join(', '))}</div></div>`;
            }
            // Case C: Standard Value
            else {
                html += `<div class="detail-item"><span class="detail-label">${label}</span><div class="detail-value">${escapeHtml(String(value))}</div></div>`;
            }
        }
        html += `</div>`; // Close grid

        // 3. Technical Meta
        html += `<div style="margin-top:20px; font-size:0.8rem; color:#999; border-top:1px solid #eee; padding-top:10px;">
            Tracking ID: ${sub.id} <br>
            Language: ${sub.language.toUpperCase()}
        </div>`;

        modalBody.innerHTML = html;
        document.getElementById('modal').style.display = 'flex';
    };

    window.closeModal = () => { document.getElementById('modal').style.display = 'none'; };

    window.saveStatus = async () => {
        if(!selectedId) return;
        const newStatus = document.getElementById('modal-status').value;
        const btn = document.querySelector('.save-btn');
        const originalText = btn.innerText;
        btn.innerText = "Saving...";
        btn.disabled = true;
        
        try {
            const ref = doc(db, "submissions", selectedId);
            await updateDoc(ref, { status: newStatus });
            
            // Update local data so we don't need to reload
            const sub = currentSubmissions.find(s => s.id === selectedId);
            if(sub) sub.status = newStatus;
            
            alert("Status Updated!");
            closeModal();
            loadSubmissions(); 
        } catch (e) {
            alert("Error: " + e.message);
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    };

    // Helper to prevent XSS attacks
    function escapeHtml(text) {
        if (!text) return '';
        return String(text)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function formatStatus(s) {
        return s ? s.replace(/_/g, ' ').toUpperCase() : 'NEW';
    }
   </script>
</body>
</html>
